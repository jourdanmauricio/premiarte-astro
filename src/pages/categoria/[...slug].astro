---
import MainLayout from '@/layouts/MainLayout.astro';
import * as actions from '@/actions/products/get-products-by-category';
import * as actionsCategories from '@/actions/categoeries/get-categories-by-page.action';
import type { Category } from '@/shared/types';
import CategoriesPage from '@/components/categories/CategoriesPage.astro';

const searchParams = Astro.url.searchParams;
//
// Enfoque alternativo usando Astro.request.url
const requestUrl = new URL(Astro.request.url);
const requestSearchParams = requestUrl.searchParams;

const pageParam = Number(
  searchParams.get('page') ?? requestSearchParams.get('page') ?? 1
);

const { slug } = Astro.params;

const { data, error } = await Astro.callAction(actions.getProductsByCategory, {
  category: slug ?? '',
  page: pageParam,
});

if (error) {
  Astro.redirect('/productos');
}

const { products, totalPages } = data || { products: [], totalPages: 0 };

const url = Astro.url;
const pathname = url.pathname;

const { data: categoriesData, error: categoriesError } = await Astro.callAction(
  actionsCategories.getCategoriesByPage,
  {}
);

if (categoriesError) {
  Astro.redirect('/categorias');
}

const categories = categoriesData as unknown as Category[];
---

{/*  image={categories[0].image.url} */}
<MainLayout title={slug} description={categories[0].description}>
  <CategoriesPage
    categories={categories}
    products={products}
    totalPages={totalPages}
    pathname={pathname}
  />
</MainLayout>
