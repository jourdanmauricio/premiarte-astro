---
import MainLayout from '@/layouts/MainLayout.astro';
import * as actions from '@/actions/products/get-product-by-slug.action';
import type { ProductWithCategoriesAndImages } from '@/shared/types';
import { Database } from '@/lib/db';
import ProductPage from '@/components/product/ProductPage.astro';

export const prerender = true;

export async function getStaticPaths() {
  try {
    // Obtener todos los productos activos de la base de datos
    const products = await Database.getAllProducts({ status: true });

    // Generar rutas para cada producto que tenga slug
    const paths = products
      .filter((product: any) => product.slug) // Solo productos con slug
      .map((product: any) => ({
        params: { slug: product.slug },
      }));

    return paths;
  } catch (error) {
    console.error('Error generating static paths for products:', error);
    return [];
  }
}

const { slug } = Astro.params;

const { data, error } = await Astro.callAction(actions.getProductBySlug, {
  slug: slug ?? '',
});

if (error) {
  Astro.redirect('/productos');
}

if (data?.length === 0) {
  Astro.redirect('/productos');
}

const product = data as unknown as ProductWithCategoriesAndImages;
---

<MainLayout
  title={product.name}
  description={product.description}
  image={product.images[0].url}
>
  <ProductPage product={product} />
</MainLayout>
