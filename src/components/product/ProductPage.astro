---
import { Image } from 'astro:assets';
import type { ProductWithCategoriesAndImages } from '@/shared/types';

const { product } = Astro.props;

const productDetails = product as ProductWithCategoriesAndImages;
---

<div class='mx-auto max-w-[1200px] my-20'>
  <div class='flex flex-col lg:flex-row gap-12 w-full'>
    <div class='w-full lg:w-1/2 mx-auto px-4'>
      <Image
        src={productDetails.images[0].url}
        alt={productDetails.images[0].alt}
        width={400}
        height={400}
        class='object-contain mx-auto object-center w-[400px] h-[400px]'
      />
      <div class='flex gap-2 mt-4 max-w-[400px] mx-auto'>
        {
          productDetails.images.map((image) => (
            <div class='min-w-0'>
              <Image
                src={image.url}
                alt={image.alt}
                width={90}
                height={90}
                class='object-contain object-center w-[90px] h-[90px]'
              />
            </div>
          ))
        }
      </div>
    </div>

    <section class='w-full lg:w-1/2 px-4 flex flex-col justify-between gap-8'>
      <h2 class='text-2xl font-semibold text-orange-500'>
        {productDetails.name} - {productDetails.sku}
      </h2>

      <div class='flex flex-col gap-2'>
        <h3 class='font-semibold'>Descripción</h3>
        <p class='ml-4 text-muted-foreground'>{productDetails.description}</p>
      </div>

      <div class='flex flex-col gap-2'>
        <h3 class='font-semibold'>Categorías</h3>
        <p class='ml-4 text-muted-foreground'>
          {
            productDetails.categories
              .map((category) => category.name)
              .join(', ')
          }
        </p>
      </div>

      <div class='flex flex-col gap-2'>
        <h3 class='font-semibold'>Cantidad</h3>
        <div class='flex items-center gap-4'>
          <button class='btn-quantity w-8 h-8'>-</button>
          <input
            class='text-center w-12 h-8 border border-gray-300 rounded-md'
            type='text'
            min='1'
            value='1'
          />
          <button class='btn-quantity w-8 h-8'>+</button>
        </div>
      </div>

      <button
        class='text-lg font-semibold bg-orange-500 rounded-sm flex items-center justify-center
    hover:bg-orange-500/80 transition-all duration-300 hover:cursor-pointer text-white py-2 w-full
    disabled:bg-gray-500 disabled:cursor-not-allowed'
      >
        Añadir al carrito
      </button>
    </section>
  </div>

  <input type='hidden' id='product-id' value={productDetails.id} />
</div>

<script>
  import { itemsInCart } from '@/store';
  import { CartCookiesClient } from '@/utils/cart-cookies';
  import { navigate } from 'astro:transitions/client';

  document.addEventListener('astro:page-load', () => {
    const quantityInput = document.querySelector('input') as HTMLInputElement;
    const productIdInput = document.querySelector(
      '#product-id'
    ) as HTMLInputElement;

    let quantity = 1;

    const [decrementButton, incrementButton, addToCartButton] =
      document.querySelectorAll('button');

    if (!incrementButton || !quantityInput) {
      return;
    }

    incrementButton.addEventListener('click', () => {
      quantity++;
      quantityInput.value = quantity.toString();
    });

    decrementButton.addEventListener('click', () => {
      quantity = Math.max(quantity - 1, 1);
      quantityInput.value = quantity.toString();
    });

    addToCartButton.addEventListener('click', async () => {
      addToCartButton.disabled = true;

      const cart = CartCookiesClient.addIem({
        productId: productIdInput.value,
        quantity: quantityInput.value,
      });

      itemsInCart.set(cart.length);

      // TODO: utilizar view transition api
      // addToCartButton.disabled = false;

      //  window.location.href = '/cart';
      await navigate('/cart');
    });
  });
</script>
